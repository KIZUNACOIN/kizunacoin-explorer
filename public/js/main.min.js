function init(e,t){nodes=e,edges=t,firstUnit=nodes[0].rowid,lastUnit=nodes[nodes.length-1].rowid,phantoms={},notStable=[],nextPositionUpdates=null,generateOffset=0,newOffset=-120,oldOffset=null,createCy(),generate(nodes,edges),_cy.viewport({zoom:1.01}),_cy.center(_cy.nodes()[0]),page="dag",location.hash&&45==location.hash.length&&(notLastUnitUp=!0,highlightNode(location.hash.substr(1)))}function start(){!location.hash||45!=location.hash.length&&33!=location.hash.length?socket.emit("start",{type:"last"}):45==location.hash.length?(socket.emit("start",{type:"unit",unit:location.hash.substr(1)}),notLastUnitUp=!0):33==location.hash.length&&(socket.emit("start",{type:"address",address:location.hash.substr(1)}),$("#addressInfo").show())}function createCy(){_cy=cytoscape({container:document.getElementById("cy"),boxSelectionEnabled:!1,autounselectify:!0,hideEdgesOnViewport:!1,layout:{name:"preset"},style:[{selector:"node",style:{content:"data(unit_s)","text-opacity":1,"min-zoomed-font-size":13,"text-valign":"bottom","text-halign":"center","font-size":"13px","text-margin-y":"5px","background-color":"#fff","border-width":3,"border-color":"#2c3e50",width:25,height:25}},{selector:"node.hover",style:{content:"data(id)","text-opacity":1,"font-weight":"bold","font-size":"14px","text-background-color":"#fff","text-background-opacity":1,"text-background-shape":"rectangle","text-border-opacity":1,"text-border-width":4,"text-border-color":"#fff","z-index":9999}},{selector:"edge",style:{width:3,"target-arrow-shape":"triangle","line-color":"#99abd5","target-arrow-color":"#99abd5","curve-style":"bezier"}},{selector:".best_parent_unit",style:{width:4.5,"target-arrow-shape":"triangle","line-color":"#99abd5","target-arrow-color":"#99abd5","curve-style":"bezier"}},{selector:".is_on_main_chain",style:{"border-color":"#0ec3a0"}},{selector:".is_stable",style:{"background-color":"#99abd5"}},{selector:".active",style:{"background-color":"#2980b9","border-width":"0"}}],elements:{nodes:[],edges:[]}}),_cy.on("mouseover","node",function(){this.addClass("hover")}),_cy.on("mouseout","node",function(){this.removeClass("hover")}),_cy.on("click","node",function(e){location.hash="#"+e.cyTarget.id()}),_cy.on("tap","node",function(e){location.hash="#"+e.cyTarget.id()}),_cy.on("pan",function(){var e=_cy.extent();nextPositionUpdates<e.y2?getNext():notLastUnitUp===!0&&e.y2-e.h<_cy.getElementById(nodes[0].data.unit).position().y&&getPrev()}),$(_cy.container()).on("wheel mousewheel",function(e){var t=e.originalEvent.wheelDeltaY||-e.originalEvent.deltaY;"dag"==page&&(e.preventDefault(),t>0?scrollUp():t<0&&_cy.panBy({x:0,y:-25}))})}function generate(e,t){var n,s,a,i,o=1/0,d=-(1/0),r=!1,c=[],l="",h=createGraph(e,t);h.nodes().forEach(function(e){a=h.node(e),a&&(a.x<o&&(o=a.x),a.x>d&&(d=a.x))}),h.nodes().forEach(function(e){a=h.node(e),a&&(l="",a.is_on_main_chain&&(l+="is_on_main_chain "),a.is_stable?l+="is_stable ":notStable.indexOf(e)==-1&&notStable.push(e),r||(n=-a.x-(d-o)/2,s=generateOffset-a.y+120,r=!0),phantoms[e]?(_cy.remove(_cy.getElementById(e)),c.push({group:"nodes",data:{id:e,unit_s:a.label},position:{x:phantoms[e],y:a.y+s},classes:l}),delete phantoms[e]):(i=setMaxWidthNodes(a.x+n),0==i&&0==a.is_on_main_chain&&(i+=40),c.push({group:"nodes",data:{id:e,unit_s:a.label},position:{x:i,y:a.y+s},classes:l})))}),c=fixConflicts(c),_cy.add(c),generateOffset=_cy.nodes()[_cy.nodes().length-1].position().y,nextPositionUpdates=generateOffset,_cy.add(createEdges())}function setNew(e,t){var n,s,a,i,o,d,r=1/0,c=-(1/0),l=1/0,h=-(1/0),g=!1,f=[],p="",u=createGraph(e,t);u.nodes().forEach(function(e){o=u.node(e),o&&(i=o.y,i<r&&(r=i),i>c&&(c=i),o.x<l&&(l=o.x),o.x>h&&(h=o.x))}),u.nodes().forEach(function(e){o=u.node(e),o&&(p="",o.is_on_main_chain&&(p+="is_on_main_chain "),o.is_stable?p+="is_stable ":notStable.indexOf(e)==-1&&notStable.push(e),g||(n=-o.x-(h-l)/2,s=newOffset-(c-r)+o.y+120,oldOffset=s+120,newOffset-=c-r+o.y+120,g=!0,_cy.extent().y1<oldOffset&&(_cy.stop(),_cy.animate({pan:{x:_cy.pan("x"),y:_cy.pan("y")+(c-r+o.y)+86}},{duration:300}))),a=o.x+n,i=o.y+s,d=setMaxWidthNodes(a),0==d&&0==o.is_on_main_chain&&(d+=40),f.push({group:"nodes",data:{id:e,unit_s:o.label},position:{x:d,y:i},classes:p}))}),f=fixConflicts(f),_cy.add(f),_cy.add(createEdges())}function createGraph(e,t){var n=new dagre.graphlib.Graph({multigraph:!0,compound:!0});n.setGraph({}),n.setDefaultEdgeLabel(function(){return{}}),e.forEach(function(e){n.setNode(e.data.unit,{label:e.data.unit_s,width:32,height:32,is_on_main_chain:e.is_on_main_chain,is_stable:e.is_stable})});for(var s in t)t.hasOwnProperty(s)&&n.setEdge(t[s].data.source,t[s].data.target);return dagre.layout(n),n}function setMaxWidthNodes(e){return e>500?e/(e/500):e<-500?-(e/(e/500)):e}function fixConflicts(e){var t,n,s,a,i={};for(t=0,s=e.length;t<s;t++)for(n=0;n<s;n++)t!=n&&e[t].position.x<e[n].position.x+10&&e[t].position.x>e[n].position.x-10&&e[t].position.y==e[n].position.y&&(i[e[t].position.y]||(i[e[t].position.y]=[]),i[e[t].position.y].push(e[t]));for(var o in i){var d=0,r=[];for(n=0,a=i[o].length;n<a;n++)for(t=0;t<s;t++)e[t].data.id==i[o][n].data.id&&r.indexOf(e[t].data.id)==-1&&(r.push(e[t].data.id),e[t].position.x<0?d-=60:d+=60,e[t].position.x+=d)}return e}function createEdges(){for(var e,t,n=cloneObj(edges),s=_cy.edges(),a=s.length,i=[],o=0,d="",r=0,c=a;r<c;r++)e=s[r].source()+"_"+s[r].target(),n[e]&&delete n[e];for(e in n)n.hasOwnProperty(e)&&(d="",d+=n[e].best_parent_unit?"best_parent_unit":"",_cy.getElementById(n[e].data.target).length?i.push({group:"edges",data:n[e].data,classes:d}):(t=_cy.getElementById(n[e].data.source).position(),phantoms[n[e].data.target]=t.x+o,i.push({group:"nodes",data:{id:n[e].data.target,unit_s:n[e].data.target.substr(0,7)+"..."},position:{x:t.x+o,y:generateOffset+120}}),o+=60,i.push({group:"edges",data:n[e].data,classes:d})));return i}function setChangesStableUnits(e){if(e){var t;e.forEach(function(e){t=_cy.getElementById(e.unit),t&&(t.hasClass("is_stable")||t.addClass("is_stable"),1!==e.is_on_main_chain||t.hasClass("is_on_main_chain")?0===e.is_on_main_chain&&t.hasClass("is_on_main_chain")&&t.removeClass("is_on_main_chain"):t.addClass("is_on_main_chain")),notStable.splice(notStable.indexOf(e.unit),1)})}}function cloneObj(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function highlightNode(e){_cy||createCy(),activeNode&&_cy.getElementById(activeNode).removeClass("active");var t=_cy.getElementById(e);return t.length?(bWaitingForPrev=!0,lastActiveUnit=location.hash.substr(1),t.addClass("active"),activeNode=t.id(),socket.emit("info",{unit:activeNode}),_cy.stop(),_cy.animate({pan:{x:_cy.pan("x"),y:_cy.getCenterPan(t).y},complete:function(){bWaitingForPrev=!1}},{duration:250}),page="dag"):(waitGo=e,getHighlightNode(waitGo)),!1}function scrollUp(){var e=_cy.extent();notLastUnitUp===!1&&e.y2-e.h/2>_cy.getElementById(nodes[0].data.unit).position().y+20||notLastUnitUp===!0&&e.y2-e.h>_cy.getElementById(nodes[0].data.unit).position().y?_cy.panBy({x:0,y:25}):notLastUnitUp===!0&&getPrev()}function showHideBlock(e){var t,n=$("#"+e);t=event.target.classList.contains("infoTitle")?$(event.target):$(event.target.parentNode),"none"===n.css("display")?(n.show(250),t.removeClass("hideTitle")):(n.hide(250),t.addClass("hideTitle"))}function searchForm(e){44==e.length||32==e.length?location.hash=e:showInfoMessage("Please enter a unit or address"),$("#inputSearch").val("")}function generateMessageInfo(e,t,n){var s,a,i="",o=0;return e.forEach(function(e){if(("payment"==e.app||"text"==e.app||"asset"==e.app)&&e.payload){switch(a=e.payload.asset||"null",i+='<div class="message"><div class="message_app infoTitleChild" onclick="showHideBlock(\'message_'+o+"')\">",i+="payment"==e.app?e.app.substr(0,1).toUpperCase()+e.app.substr(1)+" in "+(a?a:"bytes"):"asset"==e.app?"Definition of new asset":e.app.substr(0,1).toUpperCase()+e.app.substr(1),i+='</div><div class="messagesInfo" id="message_'+o++ +'">',e.app){case"payment":e.payload&&(i+='<div class="message_inputs"><div class="infoTitleInputs" onclick="showHideBlock(\'message_'+o+'\')">Inputs</div><div class="inputsInfo" id="message_'+o++ +'">',e.payload.inputs.forEach(function(e){e.type&&"issue"==e.type?i+='<div class="infoTitleInput" onclick="showHideBlock(\'message_'+o+'\')">Issue</div><div class="inputInfo" id="message_'+o++ +'"><div>Serial number: '+e.serial_number+"</div><div>Amount: "+e.amount+"</div></div>":(s=e.unit+"_"+e.output_index+"_"+a,i+="<div>"+t[s].amount+' from <a href="#'+t[s].unit+'">'+t[s].unit+"</a></div>")}),i+='</div></div><div class="message_outputs"><div class="infoTitleInputs" onclick="showHideBlock(\'message_'+o+'\')">Outputs</div><div class="inputsInf" id="message_'+o++ +'">',n[a].forEach(function(e){i+='<div class="outputs_div">',i+=e.is_spent?"<div>"+e.amount+' to <a href="#'+e.address+'">'+e.address+'</a><br> (spent in <a href="#'+e.spent+'">'+e.spent+"</a>)</div>":"<div>"+e.amount+' to <a href="#'+e.address+'">'+e.address+"</a><br> (not spent)</div>",i+="</div>"}),i+="</div></div>");break;case"text":i+="<div>Text: "+e.payload+"</div>";break;case"asset":for(var d in e.payload)"denominations"!=d&&(i+='<div class="asset">'+d+": "+e.payload[d]+"</div>")}i+="</div></div>"}}),i}function generateTransactionsList(e,t){var n,s,a,i="";for(var o in e){n=e[o],i+='<tr><th colspan="3" align="left"><div class="transactionUnit"><a href="#'+n.unit+'">'+n.unit+"</a></div></th><tr><td>",n.from.forEach(function(e){s=e.address==t?'<span class="thisAddress">'+e.address+"</span>":'<a href="#'+e.address+'">'+e.address+"</a>",i+=e.issue?'<div class="transactionUnitListAddress"><div>'+s+"</div><div>Issue "+e.amount+" "+n.asset+"</div><div>serial number: "+e.serial_number+"</div></div>":'<div class="transactionUnitListAddress"><div>'+s+"</div><div>("+e.amount+" "+(null==n.asset?"bytes":n.asset)+")</div></div>"}),i+='</td><td><img width="32" src="'+(n.spent?"/img/red_right2.png":"/img/green_right2.png")+'"></td><td>';for(var o in n.to)a=n.to[o],s=a.address==t?'<span class="thisAddress">'+a.address+"</span>":'<a href="#'+a.address+'">'+a.address+"</a>",i+='<div class="transactionUnitListAddress"><div>'+s+"</div><div>("+a.amount+" "+(null==n.asset?"bytes":n.asset)+", "+(0===a.spent?"not spent":'spent in <a href="#'+a.spent+'">'+a.spent+"</a>")+")</div></div>";i+="</td></tr>"}return i}function getNew(){notLastUnitUp||(bWaitingForNew?bHaveDelayedNewRequests=!0:(socket.emit("new",{unit:firstUnit,notStable:notStable}),bWaitingForNew=!0))}function getNext(){bWaitingForNext||(socket.emit("next",{last:lastUnit,notStable:notStable}),bWaitingForNext=!0)}function getPrev(){bWaitingForPrev||(socket.emit("prev",{first:firstUnit,notStable:notStable}),bWaitingForPrev=!0)}function getHighlightNode(e){bWaitingForHighlightNode||(socket.emit("highlightNode",{first:firstUnit,last:lastUnit,unit:e}),bWaitingForHighlightNode=!0)}function getNextPageTransactions(){bWaitingForNextPageTransactions||33!=location.hash.length||(socket.emit("nextPageTransactions",{address:location.hash.substr(1),page:pageTransactions}),bWaitingForNextPageTransactions=!0)}function adaptiveShowInfo(){$("#cy").addClass("showInfoBlock"),$("#info").removeClass("hideInfoBlock")}function closeInfo(){$("#info").addClass("hideInfoBlock"),$("#cy").removeClass("showInfoBlock")}function closeAddress(){$("#addressInfo").hide(),$("#blockListUnspent").hide(),_cy&&lastActiveUnit?location.hash=lastActiveUnit:($("#cy").show(),socket.emit("start",{type:"last"}),location.hash=""),page="dag"}function showInfoMessage(e,t){t||(t=3e3),timerInfoMessage&&clearTimeout(timerInfoMessage),$("#infoMessage").html(e).show(350),timerInfoMessage=setTimeout(function(){$("#infoMessage").hide(350).html("")},t)}function hideInfoMessage(){timerInfoMessage&&clearTimeout(timerInfoMessage),$("#infoMessage").hide(350).html("")}var _cy,nodes,edges,firstUnit,lastUnit,phantoms={},notStable=[],nextPositionUpdates,generateOffset=0,newOffset=-120,oldOffset,activeNode,waitGo,notLastUnitUp=!1,notLastUnitDown=!0,lastActiveUnit,page;window.addEventListener("hashchange",function(){45==location.hash.length?(highlightNode(location.hash.substr(1)),"block"==$("#addressInfo").css("display")&&$("#addressInfo").hide()):33==location.hash.length&&socket.emit("start",{type:"address",address:location.hash.substr(1)})}),window.addEventListener("keydown",function(e){"dag"==page&&(38==e.keyCode?(e.preventDefault(),scrollUp()):40==e.keyCode&&(e.preventDefault(),_cy.panBy({x:0,y:-25})))},!0),$(window).scroll(function(){$(window).scrollTop()+$(window).height()+200>=$(document).height()&&(nextPageTransactionsEnd||getNextPageTransactions())});var socket=io.connect(location.href),bWaitingForNext=!1,bWaitingForNew=!1,bHaveDelayedNewRequests=!1,bWaitingForPrev=!1,bWaitingForHighlightNode=!1,bWaitingForNextPageTransactions=!1,nextPageTransactionsEnd=!1,pageTransactions=0;socket.on("connect",function(){start()}),socket.on("start",function(e){init(e.nodes,e.edges),e.not_found&&showInfoMessage("Unit not found"),notLastUnitDown=!0,bWaitingForHighlightNode&&(bWaitingForHighlightNode=!1)}),socket.on("next",function(e){if(notLastUnitDown){bWaitingForHighlightNode&&(bWaitingForHighlightNode=!1),nodes=nodes.concat(e.nodes);for(var t in e.edges)e.edges.hasOwnProperty(t)&&(edges[t]=e.edges[t]);lastUnit=nodes[nodes.length-1].rowid,generate(e.nodes,edges),bWaitingForNext=!1,waitGo&&(highlightNode(waitGo),waitGo=!1),0===e.nodes.length&&(notLastUnitDown=!1),setChangesStableUnits(e.arrStableUnits)}}),socket.on("prev",function(e){bWaitingForHighlightNode&&(bWaitingForHighlightNode=!1),nodes=[].concat(e.nodes,nodes);for(var t in e.edges)e.edges.hasOwnProperty(t)&&(edges[t]=e.edges[t]);firstUnit=nodes[0].rowid,setNew(e.nodes,edges),bWaitingForPrev=!1,e.end===!0&&(notLastUnitUp=!1),waitGo&&(highlightNode(waitGo),waitGo=!1),setChangesStableUnits(e.arrStableUnits)}),socket.on("info",function(e){if(bWaitingForHighlightNode&&(bWaitingForHighlightNode=!1),e){var t="",n="",s="",a="";e.child.forEach(function(e){t+='<div><a href="#'+e+'">'+e+"</a></div>"}),e.parents.forEach(function(e){n+='<div><a href="#'+e+'">'+e+"</a></div>"}),e.authors.forEach(function(e){s+='<div><a href="#'+e.address+'">'+e.address+"</a></div>"}),e.witnesses.forEach(function(e){a+='<div><a href="#'+e+'">'+e+"</a></div>"}),$("#unit").html(e.unit),$("#children").html(t),$("#parents").html(n),$("#authors").html(s),$("#fees").html(parseInt(e.headers_commission)+parseInt(e.payload_commission)+" ("+e.headers_commission+" headers, "+e.payload_commission+" payload)"),$("#level").html(e.level),$("#main_chain_index").html(e.main_chain_index),$("#latest_included_mc_index").html(e.latest_included_mc_index),$("#is_stable").html(e.is_stable),$("#witnesses").html(a),$("#messages").html(generateMessageInfo(e.messages,e.transfersInfo,e.outputsUnit)),"none"==$("#listInfo").css("display")&&($("#defaultInfo").hide(),$("#listInfo").show()),adaptiveShowInfo()}else showInfoMessage("Unit not found")}),socket.on("update",getNew),socket.on("new",function(e){if(e.nodes.length){nodes=[].concat(e.nodes,nodes);for(var t in e.edges)e.edges.hasOwnProperty(t)&&(edges[t]=e.edges[t]);firstUnit=nodes[0].rowid,setNew(e.nodes,edges),bWaitingForNew=!1,bHaveDelayedNewRequests&&(bHaveDelayedNewRequests=!1,getNew())}else bWaitingForNew=!1;setChangesStableUnits(e.arrStableUnits)}),socket.on("addressInfo",function(e){if(e){var t="",n="";pageTransactions=1,nextPageTransactionsEnd=e.end;for(var s in e.objBalance)n+="bytes"===s?"<div>"+e.objBalance[s]+" bytes</div>":"<div>"+e.objBalance[s]+" of "+s+"</div>";e.unspent.forEach(function(e){t+='<div><a href="#'+e.unit+'">'+e.unit+"</a> ("+e.amount+" "+(null==e.asset?"bytes":e.asset)+")</div>"}),$("#address").html(e.address),$("#balance").html(n),$("#listUnspent").html(t),$("#listUnits").html(generateTransactionsList(e.objTransactions,e.address)),""!=t?$("#blockListUnspent").show():$("#blockListUnspent").hide(),"none"==$("#addressInfo").css("display")&&$("#addressInfo").show(),page="address"}else showInfoMessage("Address not found");bWaitingForNextPageTransactions=!1}),socket.on("nextPageTransactions",function(e){e&&(pageTransactions++,nextPageTransactionsEnd=e.end,$("#listUnits").append(generateTransactionsList(e.objTransactions,e.address))),bWaitingForNextPageTransactions=!1});var timerInfoMessage;